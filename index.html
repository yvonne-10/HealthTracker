<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weight & Health Monthly Tracker</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#13151b;--card:#181b22;--muted:#9aa3ab;--text:#eaf1f6;--accent:#66e0a3;--line:#262a33;
      --green:#16a34a;--blue:#3b82f6;--red:#ef4444;--gray:#6b7280;
      --series-weight:#66e0a3;--series-fat:#7aa2f7;--series-cal:#f59e0b;
    }
    *{box-sizing:border-box}
    html{ -webkit-text-size-adjust:100%; }
    body{margin:0;background:var(--bg);color:var(--text);font:clamp(11px,1.7vw,14px)/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}

    /* Top app bar */
    .appbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;background:var(--panel);padding:8px 10px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:0;font-size:clamp(14px,2.5vw,18px);letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    select,button,input[type="month"],input[type="number"],input[type="text"]{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-size:inherit}
    button{cursor:pointer}
    .tabs{display:flex;gap:6px;margin-top:8px}
    .tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted)}
    .tab.active{background:var(--accent);color:#092316;border-color:transparent}

    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
    .dow{color:var(--muted);text-align:center;padding:2px 0}
    .cell{background:var(--card);border:1px solid var(--line);border-radius:12px;min-height:134px;display:flex;flex-direction:column;overflow:hidden}
    .cell-head{display:flex;justify-content:space-between;align-items:center;gap:8px;background:transparent;border-bottom:1px solid var(--line);padding:6px 8px}
    .date{font-weight:700;font-size:clamp(12px,1.8vw,14px)}
    .today{outline:2px solid var(--accent);border-radius:8px}
    .content{padding:6px 6px;display:flex;flex-direction:column;gap:3px}

    /* PHONE-FRIENDLY INPUT ROWS */
    .field{display:flex;align-items:center;gap:6px}
    .field input,.field select{flex:1;min-width:0;height:32px;padding:4px 8px;border-radius:8px;border:1px solid var(--line);background:var(--card);color:var(--text)}
    .field .dot{width:8px;height:8px;border-radius:50%}

    /* Chart area */
    #chartWrap{display:none;margin-top:10px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:8px}
    #chartControls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;align-items:center}
    #chartInfo{color:var(--muted);font-size:clamp(10px,1.6vw,12px);margin-top:6px}
    canvas{width:100%;max-width:100%;height:400px;border-radius:10px;background:#0f1218;border:1px solid #1b2130}

    @media (max-width:720px){
      .cell{min-height:128px}
      .content{gap:2px}
      .field input,.field select{height:30px}
      canvas{height:320px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="appbar">
      <h1>Weight & Health Monthly Tracker</h1>
      <div class="controls">
        <button id="prevBtn" title="Previous month">◀</button>
        <input id="monthPicker" type="month" />
        <button id="nextBtn" title="Next month">▶</button>
        <button id="todayBtn">Today</button>
        <button id="exportBtn">Export Month JSON</button>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input id="autoSaveToggle" type="checkbox" checked /> Auto‑save
        </label>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabCalendar">Calendar view</button>
      <button class="tab" id="tabChart">Chart view</button>
    </div>

    <!-- CALENDAR VIEW -->
    <section id="calendarWrap">
      <div class="legend" style="color:var(--muted);font-size:clamp(10px,1.6vw,12px);margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot" style="background:var(--series-weight)"></span> Weight line</span>
        <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot" style="background:var(--series-fat)"></span> Fat % line</span>
        <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot" style="background:var(--series-cal)"></span> Calories line</span>
        <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot" style="background:var(--blue)"></span> Sport: Aerobic bars</span>
        <span style="display:inline-flex;align-items:center;gap:6px"><span class="dot" style="background:var(--red)"></span> Sport: Anaerobic bars</span>
      </div>
      <div class="grid" id="dow"></div>
      <div class="grid" id="calendar"></div>
      <div class="note" style="color:var(--muted);font-size:clamp(10px,1.6vw,12px);margin-top:6px">Tap a cell to edit. Data stays in your browser.</div>
    </section>

    <!-- CHART VIEW -->
    <section id="chartWrap">
      <div id="chartControls">
        <label><input type="checkbox" id="chkWeight" checked> Weight</label>
        <label><input type="checkbox" id="chkFat" checked> Body fat %</label>
        <label><input type="checkbox" id="chkCalories" checked> Calories</label>
        <label><input type="checkbox" id="chkSport" checked> Sport time bars</label>
      </div>
      <canvas id="weightChart" width="1100" height="400" aria-label="Chart"></canvas>
      <div id="chartInfo">Left axis: **Weight** auto-scales to your data (snapped to 5 kg; integer ticks only). Right inside: **Fat** 10–35%. Right outside: **Calories** (auto‑scaled). Bottom bars: **Sport time** (blue=aerobic, red=anaerobic).</div>
    </section>
  </div>

<script>
(function(){
  // ====== DOM & CONSTANTS ======
  const STORAGE_KEY = 'wm_tracker_v5';
  const $ = sel => document.querySelector(sel);
  const calendarEl = $('#calendar');
  const monthPicker = $('#monthPicker');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const todayBtn = $('#todayBtn');
  const exportBtn = $('#exportBtn');
  const autoSaveToggle = $('#autoSaveToggle');
  const tabCalendar = $('#tabCalendar');
  const tabChart = $('#tabChart');
  const calendarWrap = $('#calendarWrap');
  const chartWrap = $('#chartWrap');
  const chartCanvas = $('#weightChart');
  const ctx = chartCanvas.getContext('2d');
  const chkWeight = $('#chkWeight');
  const chkFat = $('#chkFat');
  const chkCalories = $('#chkCalories');
  const chkSport = $('#chkSport');

  // DOW header
  const dowNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const dowEl = $('#dow');
  dowNames.forEach(d => { const e=document.createElement('div'); e.className='dow'; e.textContent=d; dowEl.appendChild(e); });

  // ====== HELPERS ======
  const pad2 = n => n.toString().padStart(2,'0');
  const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const ymKey = (y,m) => `${y}-${pad2(m+1)}`;

  function readStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(e){ return {}; } }
  function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
  function getMonthData(year, month){ const s=readStore(); return s[ymKey(year,month)]||{}; }
  function setDayData(dateStr, data){ const s=readStore(); const [y,m]=dateStr.split('-'); const mk=`${y}-${m}`; s[mk]=s[mk]||{}; s[mk][dateStr]=data; writeStore(s); }

  function focusFirstInput(content){ const el = content.querySelector('input, select'); if(el) el.focus(); }

  // ====== CALENDAR RENDER ======
  function renderCalendar(year, month){
    calendarEl.innerHTML='';
    monthPicker.value = `${year}-${pad2(month+1)}`;

    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);
    const startWeekday = first.getDay();
    const daysInMonth = last.getDate();
    const monthData = getMonthData(year, month);

    for(let i=0;i<startWeekday;i++){ const gap=document.createElement('div'); gap.className='cell empty'; calendarEl.appendChild(gap); }

    const todayStr = ymd(new Date());

    for(let day=1; day<=daysInMonth; day++){
      const date = new Date(year, month, day);
      const dateStr = ymd(date);
      const raw = monthData[dateStr] || {};
      const data = { weight: raw.weight||'', fat: raw.fat||'', cal: raw.cal||'', sport: raw.sport||'', sptime: raw.sptime||'' };

      const cell = document.createElement('div'); cell.className = 'cell' + (dateStr===todayStr?' today':'');
      const head = document.createElement('div'); head.className='cell-head';
      const left = document.createElement('div'); left.className='date'; left.textContent = day; head.appendChild(left);
      const content = document.createElement('div'); content.className='content';

      // Debounce timer for autosave
      let t; 
      const save = ()=>{
        if(!autoSaveToggle.checked) return;
        clearTimeout(t);
        t = setTimeout(()=>{
          const payload = { weight: w.value, fat: f.value, cal: c.value, sport: spSel.value, sptime: st.value };
          setDayData(dateStr, payload);
          window.dispatchEvent(new CustomEvent('wm:changed'));
        }, 180);
      };

      // PHONE-FRIENDLY FIELDS (NO LEFT LABELS)
      // Weight
      const rowW = document.createElement('div'); rowW.className='field';
      const w = document.createElement('input'); w.type='number'; w.step='0.1'; w.inputMode='decimal'; w.placeholder='kg'; w.value=data.weight; rowW.appendChild(w);

      // Fat
      const rowF = document.createElement('div'); rowF.className='field';
      const f = document.createElement('input'); f.type='number'; f.step='0.1'; f.inputMode='decimal'; f.placeholder='%'; f.value=data.fat; rowF.appendChild(f);

      // Calories
      const rowC = document.createElement('div'); rowC.className='field';
      const c = document.createElement('input'); c.type='number'; c.step='1'; c.inputMode='numeric'; c.placeholder='kcal'; c.value=data.cal; rowC.appendChild(c);

      // Sport select
      const rowSp = document.createElement('div'); rowSp.className='field';
      const spSel = document.createElement('select'); ['','aer','ana'].forEach(v=>{ const op=document.createElement('option'); op.value=v; op.textContent = v===''?'Sport: None': (v==='aer'?'Sport: Aerobic':'Sport: Anaerobic'); spSel.appendChild(op); }); spSel.value=data.sport;
      rowSp.appendChild(spSel);

      // Sport time (minutes) - only show when sport selected
      const rowSt = document.createElement('div'); rowSt.className='field';
      const st = document.createElement('input'); st.type='number'; st.step='1'; st.inputMode='numeric'; st.placeholder='Sport time (min)'; st.value=data.sptime; rowSt.appendChild(st);
      rowSt.style.display = spSel.value? 'flex' : 'none';

      // mount
      content.appendChild(rowW);
      content.appendChild(rowF);
      content.appendChild(rowC);
      content.appendChild(rowSp);
      content.appendChild(rowSt);
      cell.appendChild(head); cell.appendChild(content); calendarEl.appendChild(cell);

      // tap to focus
      cell.addEventListener('click', (e)=>{ if(e.target.tagName!=='INPUT' && e.target.tagName!=='SELECT'){ focusFirstInput(content); } });

      // listeners
      [w,f,c,st].forEach(el=>{ el.addEventListener('input', save); el.addEventListener('change', save); });
      const updSport = ()=>{ rowSt.style.display = spSel.value? 'flex':'none'; if(!spSel.value){ st.value=''; } save(); };
      spSel.addEventListener('change', updSport);
      spSel.addEventListener('input',  updSport);
    }
  }

  // ====== CHART ======
  function dayCount(year,month){ return new Date(year, month+1, 0).getDate(); }
  function getSeries(year, month){
    const md = getMonthData(year, month); const days = dayCount(year, month);
    const F_MIN=10, F_MAX=35; // fat stays fixed

    const wPts=[], fPts=[], calPts=[], sportBars=[]; // sport as bars (minutes)
    const weights=[]; let maxSport=0;
    for(let d=1; d<=days; d++){
      const key = `${year}-${pad2(month+1)}-${pad2(d)}`; const rec = md[key]; if(!rec) continue;
      const w = parseFloat(rec.weight); if(!Number.isNaN(w)){ wPts.push({x:d, y:w}); weights.push(w); }
      const f = parseFloat(rec.fat);    if(!Number.isNaN(f)) fPts.push({x:d, y:Math.max(10, Math.min(35, f))});
      const c = parseFloat(rec.cal);    if(!Number.isNaN(c)) calPts.push({x:d, y:Math.max(0, c)});
      const minutes = parseFloat(rec.sptime); const tp = rec.sport; 
      if(!Number.isNaN(minutes) && minutes>0 && (tp==='aer' || tp==='ana')){ sportBars.push({x:d, m:minutes, t:tp}); maxSport=Math.max(maxSport, minutes); }
    }

    // Weight axis: snap to 5 kg increments, integer ticks only
    let W_MIN=50, W_MAX=80;
    if(weights.length){
      const minW = Math.min(...weights), maxW = Math.max(...weights);
      W_MIN = Math.floor(minW/5)*5; W_MAX = Math.ceil(maxW/5)*5;
      if(W_MAX===W_MIN) W_MAX = W_MIN + 5; // ensure some range
    }

    // Calories axis dynamic
    let C_MIN = 1000, C_MAX = 3500;
    if(calPts.length){
      const min = Math.min(...calPts.map(p=>p.y));
      const max = Math.max(...calPts.map(p=>p.y));
      C_MIN = Math.max(0, Math.min(1000, Math.floor((min-100)/100)*100));
      C_MAX = Math.max(1200, Math.ceil((max+100)/100)*100);
      if(C_MAX - C_MIN < 800) C_MAX = C_MIN + 800;
    }

    // Sport bar scale (minutes)
    let S_MAX = 60; if(maxSport>0) S_MAX = Math.ceil(maxSport/10)*10;

    return {wPts,fPts,calPts,sportBars,W_MIN,W_MAX,F_MIN,F_MAX,C_MIN,C_MAX,S_MAX};
  }

  function clearCanvas(){ ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height); }
  function renderChart(year, month){
    clearCanvas();
    const {wPts,fPts,calPts,sportBars,W_MIN,W_MAX,F_MIN,F_MAX,C_MIN,C_MAX,S_MAX} = getSeries(year, month);
    const w = chartCanvas.width, h = chartCanvas.height; const m={l:60,r:100,t:22,b:42};
    const xMin=1, xMax=dayCount(year, month); const xToPx = x=> m.l + (x-xMin)*(w-m.l-m.r)/(xMax-xMin);

    const sportH=70; const sportTop = h-m.b-sportH; const sportBase = h-m.b; // bottom area for sport bars
    const yW = v => sportTop - 6 - (v-W_MIN)*(sportTop - m.t - 6)/(W_MAX-W_MIN); // weight occupies area above sport bars
    const yF = v => sportTop - 6 - (v-F_MIN)*(sportTop - m.t - 6)/(F_MAX-F_MIN); // fat on right-inside
    const yC = v => sportTop - 6 - (v-C_MIN)*(sportTop - m.t - 6)/(C_MAX-C_MIN); // calories on right-outside
    const yS = v => sportBase - (v/S_MAX)*sportH; // sport minutes

    // grid & axes
    ctx.strokeStyle='#2a3140'; ctx.lineWidth=1; ctx.beginPath();
    ctx.moveTo(m.l,sportBase); ctx.lineTo(w-m.r,sportBase); // x at bottom
    ctx.moveTo(m.l,m.t); ctx.lineTo(m.l,sportTop-6); // y left (weight)
    ctx.moveTo(w-m.r,m.t); ctx.lineTo(w-m.r,sportTop-6); // y right inside (fat)
    ctx.moveTo(w-(m.r-40),m.t); ctx.lineTo(w-(m.r-40),sportTop-6); // y right outside (cal)
    ctx.moveTo(m.l,sportTop); ctx.lineTo(w-m.r,sportTop); // separator above sport bars
    ctx.stroke();

    // Weight ticks (integers only)
    ctx.fillStyle='#9aa3ab'; ctx.font='12px system-ui, Segoe UI, Roboto, Arial';
    for(let tick=W_MIN; tick<=W_MAX; tick+=1){ const yp=yW(tick); if(tick%5===0){ ctx.strokeStyle='#1e2430'; ctx.beginPath(); ctx.moveTo(m.l,yp); ctx.lineTo(w-m.r,yp); ctx.stroke(); } ctx.fillText(String(tick),8,yp+4); }

    // Fat ticks (5%)
    const r1 = w - m.r + 8; for(let tick=F_MIN; tick<=F_MAX; tick+=5){ const yp=yF(tick); ctx.fillText(String(tick)+'%', r1, yp+4); }

    // Calories ticks (500)
    const r2 = w - (m.r-40) + 8; for(let tick=C_MIN; tick<=C_MAX; tick+=500){ const yp=yC(tick); ctx.fillText(String(tick), r2, yp+4); }

    // Day ticks
    const step=Math.max(1,Math.round(xMax/6));
    for(let d=1; d<=xMax; d+=step){ const xp=xToPx(d); ctx.strokeStyle='#1e2430'; ctx.beginPath(); ctx.moveTo(xp,sportBase); ctx.lineTo(xp,m.t); ctx.stroke(); ctx.fillText(String(d), xp-6, sportBase+12); }

    function drawLine(pts,yMap,color){ if(!pts.length) return; ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath(); pts.sort((a,b)=>a.x-b.x).forEach((p,i)=>{ const xp=xToPx(p.x), yp=yMap(p.y); if(i===0) ctx.moveTo(xp,yp); else ctx.lineTo(xp,yp); }); ctx.stroke(); ctx.fillStyle=color; pts.forEach(p=>{ const xp=xToPx(p.x), yp=yMap(p.y); ctx.beginPath(); ctx.arc(xp,yp,3,0,Math.PI*2); ctx.fill(); }); }

    function drawBars(bars){ if(!bars.length) return; const totalW = (w-m.l-m.r)/(xMax-xMin+1); const bw = Math.max(4,totalW*0.6); bars.forEach(b=>{ const xp=xToPx(b.x); const x0=xp-bw/2; const y0=yS(b.m); const color = b.t==='aer'? getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() : getComputedStyle(document.documentElement).getPropertyValue('--red').trim(); ctx.fillStyle=color; ctx.fillRect(x0,y0,bw, sportBase-y0); }); }

    const cs=getComputedStyle(document.documentElement);
    if(chkWeight.checked)   drawLine(wPts, yW, cs.getPropertyValue('--series-weight').trim());
    if(chkFat.checked)      drawLine(fPts, yF, cs.getPropertyValue('--series-fat').trim());
    if(chkCalories.checked) drawLine(calPts, yC, cs.getPropertyValue('--series-cal').trim());
    if(chkSport.checked)    drawBars(sportBars);

    // labels
    ctx.fillStyle='#eaf1f6'; ctx.font='14px system-ui, Segoe UI, Roboto, Arial';
    const monthName = new Date(year, month, 1).toLocaleString(undefined,{month:'long', year:'numeric'});
    ctx.fillText(`Weight & Health – ${monthName}`, m.l, m.t-6+12);
    ctx.fillStyle='#9aa3ab'; ctx.font='12px system-ui, Segoe UI, Roboto, Arial';
    ctx.fillText('Sport time (min)', m.l+4, sportTop+12);
  }

  // ====== NAV ======
  function getPickerYM(){ const [y,m] = monthPicker.value.split('-').map(Number); return {year:y, month:m-1}; }
  function isChartActive(){ return chartWrap.style.display !== 'none'; }
  function activateCalendar(){ tabCalendar.classList.add('active'); tabChart.classList.remove('active'); calendarWrap.style.display='block'; chartWrap.style.display='none'; }
  function activateChart(){ tabChart.classList.add('active'); tabCalendar.classList.remove('active'); calendarWrap.style.display='none'; chartWrap.style.display='block'; const {year,month}=getPickerYM(); renderChart(year,month); }

  prevBtn.addEventListener('click', ()=>{ const {year,month}=getPickerYM(); const d=new Date(year,month-1,1); renderCalendar(d.getFullYear(), d.getMonth()); if(isChartActive()) renderChart(d.getFullYear(), d.getMonth()); });
  nextBtn.addEventListener('click', ()=>{ const {year,month}=getPickerYM(); const d=new Date(year,month+1,1); renderCalendar(d.getFullYear(), d.getMonth()); if(isChartActive()) renderChart(d.getFullYear(), d.getMonth()); });
  todayBtn.addEventListener('click', ()=>{ const now=new Date(); renderCalendar(now.getFullYear(), now.getMonth()); if(isChartActive()) renderChart(now.getFullYear(), now.getMonth()); });
  monthPicker.addEventListener('change', ()=>{ const {year,month}=getPickerYM(); renderCalendar(year,month); if(isChartActive()) renderChart(year,month); });
  exportBtn.addEventListener('click', ()=>{ const {year,month}=getPickerYM(); exportMonth(year,month); });
  tabCalendar.addEventListener('click', activateCalendar); tabChart.addEventListener('click', activateChart);
  ;[chkWeight,chkFat,chkCalories,chkSport].forEach(el=> el.addEventListener('change', ()=>{ if(isChartActive()){ const {year,month}=getPickerYM(); renderChart(year,month); } }));
  window.addEventListener('wm:changed', ()=>{ if(isChartActive()){ const {year,month}=getPickerYM(); renderChart(year,month); } });

  // ====== INIT ======
  const now = new Date();
  monthPicker.value = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  renderCalendar(now.getFullYear(), now.getMonth());
  activateCalendar();

  // ====== EXPORT ======
  function exportMonth(year, month){ const s=readStore(); const mk=ymKey(year,month); const blob=new Blob([JSON.stringify({[mk]: s[mk]||{}}, null, 2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`health-tracker_${mk}.json`; a.click(); URL.revokeObjectURL(url); }

  // ====== PUBLIC API & TESTS ======
  window.WMTracker = { readStore, writeStore, getMonthData, setDayData, getSeries };

  // --- Basic tests (console) ---
  (function runTests(){
    const results = [];
    const assert = (name, cond) => results.push({name, pass: !!cond});

    // Test dynamic weight range snapping (51.5..58.2 => 50..60)
    const y = now.getFullYear(), m = now.getMonth();
    const d1 = `${y}-${(m+1).toString().padStart(2,'0')}-01`;
    const d2 = `${y}-${(m+1).toString().padStart(2,'0')}-02`;
    setDayData(d1, {weight:'51.5',fat:'20',cal:'1800',sport:'aer',sptime:'30'});
    setDayData(d2, {weight:'58.2',fat:'21',cal:'1900',sport:'ana',sptime:'25'});
    const s = getSeries(y,m);
    assert('weight min snapped to 50', s.W_MIN===50);
    assert('weight max snapped to 60', s.W_MAX===60);

    // Sport bars created & colored via type
    assert('sport bars exist', s.sportBars.length>=2);

    console.log(`Tests: ${results.filter(r=>r.pass).length}/${results.length} passed`);
    results.forEach(r=> console[r.pass?'log':'error'](`${r.pass?'✔':'✘'} ${r.name}`));
  })();
})();
</script>
</body>
</html>
