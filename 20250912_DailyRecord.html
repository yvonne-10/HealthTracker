<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weight & Health Monthly Tracker</title>
  <style>
    :root{
      --bg:#0b0c10;--panel:#13151b;--card:#181b22;--muted:#9aa3ab;--text:#eaf1f6;--accent:#66e0a3;--line:#262a33;
      --series-weight:#66e0a3;--series-fat:#7aa2f7;--series-meal:#eab308;--series-sport:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}

    /* Top app bar (renamed from generic `header` to avoid conflicts) */
    .appbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;background:var(--panel);padding:14px 16px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:0;font-size:18px;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,button,input[type="month"],input[type="number"]{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#092316;border-color:transparent}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--card);color:var(--muted)}
    .tab.active{background:var(--accent);color:#092316;border-color:transparent}

    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:14px}
    .dow{color:var(--muted);text-align:center;padding:6px 0}
    .cell{background:var(--card);border:1px solid var(--line);border-radius:12px;min-height:160px;display:flex;flex-direction:column;overflow:hidden}
    .cell-head{display:flex;justify-content:space-between;align-items:center;background:transparent;border-bottom:1px solid var(--line);border-radius:0;padding:8px 10px}
    .date{font-weight:700}
    .today{outline:2px solid var(--accent);border-radius:8px}
    .content{padding:8px 10px;display:flex;flex-direction:column;gap:6px}
    .row{display:flex;gap:6px;align-items:center}
    .row label{min-width:86px;color:var(--muted)}
    .row input[type="number"]{width:100%}
    .hint{color:var(--muted);font-size:12px}
    .empty{opacity:.45}
    .legend{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:12px;margin-top:12px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.weight{background:var(--series-weight)}
    .dot.fat{background:var(--series-fat)}
    .dot.meal{background:var(--series-meal)}
    .dot.sport{background:var(--series-sport)}
    .note{margin-top:10px;color:var(--muted);font-size:12px}

    /* Chart area */
    #chartWrap{display:none;margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    #chartControls{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:10px;align-items:center}
    #chartInfo{color:var(--muted);font-size:12px;margin-top:6px}
    canvas{width:100%;max-width:100%;height:460px;border-radius:10px;background:#0f1218;border:1px solid #1b2130}

    @media (max-width:720px){
      .cell{min-height:180px}
      h1{width:100%}
      canvas{height:360px}
      .row label{min-width:74px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="appbar">
      <h1>Weight & Health Monthly Tracker</h1>
      <div class="controls">
        <button id="prevBtn" title="Previous month">◀</button>
        <input id="monthPicker" type="month" />
        <button id="nextBtn" title="Next month">▶</button>
        <button id="todayBtn">Today</button>
        <button id="exportBtn">Export Month JSON</button>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input id="autoSaveToggle" type="checkbox" checked /> Auto‑save
        </label>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabCalendar">Calendar view</button>
      <button class="tab" id="tabChart">Chart view</button>
    </div>

    <!-- CALENDAR VIEW -->
    <section id="calendarWrap">
      <div class="legend">
        <span class="badge"><span class="dot weight"></span> Weight (kg)</span>
        <span class="badge"><span class="dot fat"></span> Body Fat %</span>
        <span class="badge"><span class="dot meal"></span> Meals (0 healthy · 1 neutral · 2 unhealthy)</span>
        <span class="badge"><span class="dot sport"></span> Sport (1 aerobic · 2 anaerobic)</span>
      </div>
      <div class="grid" id="dow"></div>
      <div class="grid" id="calendar"></div>
      <div class="note">All data is saved locally in your browser. Export lets you back up a month.</div>
    </section>

    <!-- CHART VIEW -->
    <section id="chartWrap">
      <div id="chartControls">
        <label><input type="checkbox" id="chkWeight" checked> Weight</label>
        <label><input type="checkbox" id="chkFat" checked> Body fat %</label>
        <label><input type="checkbox" id="chkMeals" checked> Meals (0/1/2)</label>
        <label><input type="checkbox" id="chkSport" checked> Sport (0/1/2)</label>
      </div>
      <canvas id="weightChart" width="1100" height="460" aria-label="Chart"></canvas>
      <div id="chartInfo">Left axis: Weight 50–80 kg. Right axis: Body fat 10–35%. Bottom band marks 0/1/2 for Meals & Sport.</div>
    </section>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'wm_tracker_v2';
  const $ = sel => document.querySelector(sel);
  const calendarEl = $('#calendar');
  const monthPicker = $('#monthPicker');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const todayBtn = $('#todayBtn');
  const exportBtn = $('#exportBtn');
  const autoSaveToggle = $('#autoSaveToggle');

  const tabCalendar = $('#tabCalendar');
  const tabChart = $('#tabChart');
  const calendarWrap = $('#calendarWrap');
  const chartWrap = $('#chartWrap');
  const chartCanvas = $('#weightChart');
  const ctx = chartCanvas.getContext('2d');

  const chkWeight = $('#chkWeight');
  const chkFat = $('#chkFat');
  const chkMeals = $('#chkMeals');
  const chkSport = $('#chkSport');

  // Day-of-week header
  const dowNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const dowEl = $('#dow');
  dowNames.forEach(d => {
    const div = document.createElement('div');
    div.className = 'dow';
    div.textContent = d;
    dowEl.appendChild(div);
  });

  // Helpers
  const pad2 = n => n.toString().padStart(2,'0');
  const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const ymKey = (y,m) => `${y}-${pad2(m+1)}`; // month key

  function readStore(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    catch(e){ return {}; }
  }
  function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

  function getMonthData(year, month){
    const store = readStore();
    return store[ymKey(year,month)] || {};
  }
  function setDayData(dateStr, data){
    const store = readStore();
    const [y,m] = dateStr.split('-');
    const mk = `${y}-${m}`;
    store[mk] = store[mk] || {};
    store[mk][dateStr] = data;
    writeStore(store);
  }

  // Build a select with H/N/U options
  function buildHNUSelect(initVal){
    const sel = document.createElement('select');
    const opts = [
      {v:'', t:'—'},
      {v:'0', t:'Healthy (0)'},
      {v:'1', t:'Neutral (1)'},
      {v:'2', t:'Unhealthy (2)'}
    ];
    opts.forEach(o=>{ const op=document.createElement('option'); op.value=o.v; op.textContent=o.t; sel.appendChild(op); });
    sel.value = (initVal ?? '');
    return sel;
  }

  function buildSportSelect(initVal){
    const sel = document.createElement('select');
    const opts = [
      {v:'', t:'None'},
      {v:'aer', t:'Aerobic (1)'},
      {v:'ana', t:'Anaerobic (2)'}
    ];
    opts.forEach(o=>{ const op=document.createElement('option'); op.value=o.v; op.textContent=o.t; sel.appendChild(op); });
    sel.value = (initVal ?? '');
    return sel;
  }

  function renderCalendar(year, month){
    calendarEl.innerHTML='';
    monthPicker.value = `${year}-${pad2(month+1)}`;

    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);
    const startWeekday = first.getDay();
    const daysInMonth = last.getDate();
    const monthData = getMonthData(year, month);

    for(let i=0;i<startWeekday;i++){
      const gap = document.createElement('div');
      gap.className='cell empty';
      calendarEl.appendChild(gap);
    }

    const todayStr = ymd(new Date());

    for(let day=1; day<=daysInMonth; day++){
      const date = new Date(year, month, day);
      const dateStr = ymd(date);
      const raw = monthData[dateStr] || {};
      const data = {
        weight: raw.weight || '',
        fat: raw.fat || '',
        meals: raw.meals || {brk:'', lun:'', din:'', snk:''},
        sport: raw.sport || ''
      };

      const cell = document.createElement('div');
      cell.className = 'cell' + (dateStr===todayStr?' today':'');

      const head = document.createElement('div');
      head.className='cell-head';
      const left = document.createElement('div'); left.className='date'; left.textContent = day;
      const right = document.createElement('div'); right.className='hint'; right.textContent = hintText();
      head.appendChild(left); head.appendChild(right);

      const content = document.createElement('div'); content.className='content';

      // Weight
      const rowW = document.createElement('div'); rowW.className='row';
      const wLabel = document.createElement('label'); wLabel.textContent='Weight';
      const w = document.createElement('input'); w.type='number'; w.step='0.1'; w.placeholder='kg'; w.value=data.weight;
      rowW.appendChild(wLabel); rowW.appendChild(w);

      // Body fat %
      const rowF = document.createElement('div'); rowF.className='row';
      const fLabel = document.createElement('label'); fLabel.textContent='Body Fat %';
      const f = document.createElement('input'); f.type='number'; f.step='0.1'; f.placeholder='%'; f.value=data.fat;
      rowF.appendChild(fLabel); rowF.appendChild(f);

      // Meals
      const rowB = document.createElement('div'); rowB.className='row';
      const lbB = document.createElement('label'); lbB.textContent='Breakfast';
      const bSel = buildHNUSelect(data.meals.brk);
      rowB.appendChild(lbB); rowB.appendChild(bSel);

      const rowL = document.createElement('div'); rowL.className='row';
      const lbL = document.createElement('label'); lbL.textContent='Lunch';
      const lSel = buildHNUSelect(data.meals.lun);
      rowL.appendChild(lbL); rowL.appendChild(lSel);

      const rowD = document.createElement('div'); rowD.className='row';
      const lbD = document.createElement('label'); lbD.textContent='Dinner';
      const dSel = buildHNUSelect(data.meals.din);
      rowD.appendChild(lbD); rowD.appendChild(dSel);

      const rowS = document.createElement('div'); rowS.className='row';
      const lbS = document.createElement('label'); lbS.textContent='Snacks';
      const sSel = buildHNUSelect(data.meals.snk);
      rowS.appendChild(lbS); rowS.appendChild(sSel);

      // Sport
      const rowSp = document.createElement('div'); rowSp.className='row';
      const spLabel = document.createElement('label'); spLabel.textContent='Sport';
      const spSel = buildSportSelect(data.sport);
      rowSp.appendChild(spLabel); rowSp.appendChild(spSel);

      const box = document.createElement('div');
      box.appendChild(head);
      box.appendChild(content);

      content.appendChild(rowW);
      content.appendChild(rowF);
      content.appendChild(rowB);
      content.appendChild(rowL);
      content.appendChild(rowD);
      content.appendChild(rowS);
      content.appendChild(rowSp);

      cell.appendChild(head);
      cell.appendChild(content);
      calendarEl.appendChild(cell);

      function hintText(){
        const wv = data.weight ? `${data.weight}`:'';
        const fv = data.fat ? `${data.fat}%`:'';
        return [wv,fv].filter(Boolean).join(' / ');
      }

      // Save handler (debounced)
      let t;
      function save(){
        const payload = {
          weight: w.value,
          fat: f.value,
          meals: { brk:bSel.value, lun:lSel.value, din:dSel.value, snk:sSel.value },
          sport: spSel.value
        };
        right.textContent = [payload.weight && `${payload.weight}`, payload.fat && `${payload.fat}%`].filter(Boolean).join(' / ');
        if(!autoSaveToggle.checked) return;
        clearTimeout(t);
        t = setTimeout(()=>{
          setDayData(dateStr, payload);
          window.dispatchEvent(new CustomEvent('wm:changed'));
        }, 250);
      }

      [w,f,bSel,lSel,dSel,sSel,spSel].forEach(el=>{
        el.addEventListener('input', save);
        el.addEventListener('change', save);
      });
    }
  }

  // Data extraction for chart
  function dayCount(year,month){ return new Date(year, month+1, 0).getDate(); }
  function getSeries(year, month){
    const md = getMonthData(year, month);
    const days = dayCount(year, month);
    const W_MIN=50, W_MAX=80, F_MIN=10, F_MAX=35;

    const wPts=[], fPts=[], mealPts=[], sportPts=[];

    for(let d=1; d<=days; d++){
      const key = `${year}-${pad2(month+1)}-${pad2(d)}`;
      const rec = md[key];
      if(!rec) { continue; }

      // Weight
      const w = parseFloat(rec.weight);
      if(!Number.isNaN(w)){
        const y = Math.max(W_MIN, Math.min(W_MAX, w));
        wPts.push({x:d, y});
      }

      // Fat %
      const f = parseFloat(rec.fat);
      if(!Number.isNaN(f)){
        const y = Math.max(F_MIN, Math.min(F_MAX, f));
        fPts.push({x:d, y});
      }

      // Meals average 0..2
      const vs = [rec.meals?.brk, rec.meals?.lun, rec.meals?.din, rec.meals?.snk]
                  .map(v=> v===''? null : Number(v))
                  .filter(v=> v===0 || v===1 || v===2);
      if(vs.length){
        mealPts.push({x:d, y: vs.reduce((a,b)=>a+b,0)/vs.length});
      }

      // Sport mapping: none=0, aer=1, ana=2 (plot only if >0)
      const sp = rec.sport==='aer'?1: rec.sport==='ana'?2:0;
      if(sp>0){ sportPts.push({x:d, y:sp}); }
    }

    return {wPts,fPts,mealPts,sportPts, W_MIN,W_MAX,F_MIN,F_MAX};
  }

  function clearCanvas(){ ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height); }

  function renderChart(year, month){
    monthPicker.value = `${year}-${pad2(month+1)}`;
    clearCanvas();

    const {wPts,fPts,mealPts,sportPts,W_MIN,W_MAX,F_MIN,F_MAX} = getSeries(year, month);
    const w = chartCanvas.width; const h = chartCanvas.height;

    const m = {l:60, r:60, t:24, b:48};
    const xMin = 1; const xMax = dayCount(year, month);
    const xToPx = (x)=> m.l + (x - xMin) * (w - m.l - m.r) / (xMax - xMin);

    // y scales
    const yW = (val)=> h - m.b - (val - W_MIN) * (h - m.t - m.b - 80) / (W_MAX - W_MIN); // leave 80px band for categories
    const yF = (val)=> h - m.b - (val - F_MIN) * (h - m.t - m.b - 80) / (F_MAX - F_MIN);
    const bandH = 80; const bandTop = h - m.b - bandH; // categorical area for meals/sport
    const yCat = (v)=> bandTop + bandH - (v/2)*bandH; // 0..2 maps within band

    // Axes
    ctx.strokeStyle = '#2a3140'; ctx.lineWidth = 1; ctx.beginPath();
    ctx.moveTo(m.l, h - m.b); ctx.lineTo(w - m.r, h - m.b); // x-axis
    ctx.moveTo(m.l, m.t); ctx.lineTo(m.l, h - m.b); // left y (weight)
    ctx.moveTo(w - m.r, m.t); ctx.lineTo(w - m.r, h - m.b); // right y (fat)
    ctx.moveTo(m.l, bandTop); ctx.lineTo(w - m.r, bandTop); // band separator
    ctx.stroke();

    // Left y labels (Weight 50–80)
    ctx.fillStyle = '#9aa3ab'; ctx.font = '12px system-ui, Segoe UI, Roboto, Arial';
    for(let tick=50; tick<=80; tick+=10){
      const yp = yW(tick);
      ctx.strokeStyle = '#1e2430'; ctx.beginPath(); ctx.moveTo(m.l, yp); ctx.lineTo(w - m.r, yp); ctx.stroke();
      ctx.fillText(String(tick), 8, yp+4);
    }
    // Right y labels (Fat 10–35)
    for(let tick=10; tick<=35; tick+=5){
      const yp = yF(tick);
      ctx.strokeStyle = '#141923'; ctx.beginPath(); ctx.moveTo(m.l, yp); ctx.lineTo(w - m.r, yp); ctx.stroke();
      ctx.fillText(String(tick)+'%', w - m.r + 8, yp+4);
    }
    // Category band ticks 0/1/2
    for(let v=0; v<=2; v++){
      const yp = yCat(v);
      ctx.strokeStyle = '#1e2430'; ctx.beginPath(); ctx.moveTo(m.l, yp); ctx.lineTo(w - m.r, yp); ctx.stroke();
      ctx.fillText(String(v), w - m.r + 8, yp+4);
    }
    ctx.fillText('Meals/Sport (0–2)', w - m.r + 8, bandTop - 6);

    // Day ticks
    const step = Math.max(1, Math.round(xMax/6));
    for(let d=1; d<=xMax; d+=step){
      const xp = xToPx(d);
      ctx.strokeStyle = '#1e2430'; ctx.beginPath(); ctx.moveTo(xp, h - m.b); ctx.lineTo(xp, m.t); ctx.stroke();
      ctx.fillText(String(d), xp-6, h - m.b + 16);
    }

    // Series drawing helpers
    function drawLine(pts, yMap, color){
      if(!pts.length) return;
      ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
      pts.sort((a,b)=>a.x-b.x).forEach((p,i)=>{
        const xp = xToPx(p.x), yp = yMap(p.y);
        if(i===0) ctx.moveTo(xp, yp); else ctx.lineTo(xp, yp);
      });
      ctx.stroke();
      // dots
      ctx.fillStyle = color;
      pts.forEach(p=>{ const xp=xToPx(p.x), yp=yMap(p.y); ctx.beginPath(); ctx.arc(xp, yp, 3, 0, Math.PI*2); ctx.fill(); });
    }
    function drawPoints(pts, yMap, color, shape='circle'){
      if(!pts.length) return;
      ctx.fillStyle = color; ctx.strokeStyle = color;
      pts.forEach(p=>{
        const xp=xToPx(p.x), yp=yMap(p.y);
        if(shape==='triangle'){
          ctx.beginPath(); ctx.moveTo(xp, yp-4); ctx.lineTo(xp-4, yp+4); ctx.lineTo(xp+4, yp+4); ctx.closePath(); ctx.fill();
        }else if(shape==='square'){
          ctx.fillRect(xp-3, yp-3, 6, 6);
        }else{
          ctx.beginPath(); ctx.arc(xp, yp, 3, 0, Math.PI*2); ctx.fill();
        }
      });
    }

    // Draw series based on toggles
    if(chkWeight.checked) drawLine(wPts, yW, getComputedStyle(document.documentElement).getPropertyValue('--series-weight').trim());
    if(chkFat.checked)    drawLine(fPts, yF, getComputedStyle(document.documentElement).getPropertyValue('--series-fat').trim());
    if(chkMeals.checked)  drawPoints(mealPts, yCat, getComputedStyle(document.documentElement).getPropertyValue('--series-meal').trim(), 'circle');
    if(chkSport.checked)  drawPoints(sportPts, yCat, getComputedStyle(document.documentElement).getPropertyValue('--series-sport').trim(), 'triangle');

    // Title
    ctx.fillStyle = '#eaf1f6'; ctx.font = '14px system-ui, Segoe UI, Roboto, Arial';
    const monthName = new Date(year, month, 1).toLocaleString(undefined,{month:'long', year:'numeric'});
    ctx.fillText(`Weight & Health – ${monthName}`, m.l, m.t - 6 + 12);
  }

  // Navigation
  function getPickerYM(){
    const [y,m] = monthPicker.value.split('-').map(Number);
    return {year:y, month:m-1};
  }
  prevBtn.addEventListener('click', ()=>{
    const {year, month} = getPickerYM();
    const d = new Date(year, month-1, 1);
    renderCalendar(d.getFullYear(), d.getMonth());
    if(isChartActive()) renderChart(d.getFullYear(), d.getMonth());
  });
  nextBtn.addEventListener('click', ()=>{
    const {year, month} = getPickerYM();
    const d = new Date(year, month+1, 1);
    renderCalendar(d.getFullYear(), d.getMonth());
    if(isChartActive()) renderChart(d.getFullYear(), d.getMonth());
  });
  todayBtn.addEventListener('click', ()=>{
    const now = new Date();
    renderCalendar(now.getFullYear(), now.getMonth());
    if(isChartActive()) renderChart(now.getFullYear(), now.getMonth());
  });
  monthPicker.addEventListener('change', ()=>{
    const {year, month} = getPickerYM();
    renderCalendar(year, month);
    if(isChartActive()) renderChart(year, month);
  });
  exportBtn.addEventListener('click', ()=>{
    const {year, month} = getPickerYM();
    exportMonth(year, month);
  });

  // Tabs
  function isChartActive(){ return chartWrap.style.display !== 'none'; }
  function activateCalendar(){
    tabCalendar.classList.add('active'); tabChart.classList.remove('active');
    calendarWrap.style.display='block'; chartWrap.style.display='none';
  }
  function activateChart(){
    tabChart.classList.add('active'); tabCalendar.classList.remove('active');
    calendarWrap.style.display='none'; chartWrap.style.display='block';
    const {year, month} = getPickerYM();
    renderChart(year, month);
  }
  tabCalendar.addEventListener('click', activateCalendar);
  tabChart.addEventListener('click', activateChart);

  // Toggle re-render
  [chkWeight, chkFat, chkMeals, chkSport].forEach(el=>el.addEventListener('change', ()=>{
    if(isChartActive()){
      const {year, month} = getPickerYM();
      renderChart(year, month);
    }
  }));

  // Live-update chart
  window.addEventListener('wm:changed', ()=>{
    if(isChartActive()){
      const {year, month} = getPickerYM();
      renderChart(year, month);
    }
  });

  // Init
  const now = new Date();
  renderCalendar(now.getFullYear(), now.getMonth());
  activateCalendar();

  // Export current month only
  function exportMonth(year, month){
    const store = readStore();
    const mk = ymKey(year,month);
    const blob = new Blob([JSON.stringify({[mk]: store[mk] || {}}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `health-tracker_${mk}.json`; a.click();
    URL.revokeObjectURL(url);
  }

  // Optional developer helpers
  window.WMTracker = {
    import(json){
      try{
        const store = readStore();
        const incoming = (typeof json === 'string') ? JSON.parse(json) : json;
        Object.assign(store, incoming);
        writeStore(store);
        const {year, month} = getPickerYM();
        renderCalendar(year, month);
        if(isChartActive()) renderChart(year, month);
        return true;
      }catch(e){ console.error(e); return false; }
    },
    dump(){ return readStore(); }
  };
})();
</script>
</body>
</html>
